# راهنمای اجرای حسابداری (مطابق بازار ایران) - فاز ۱

**تاریخ:** 2026-02-26  
**هدف:** اضافه‌کردن هسته حسابداری دوبل بدون شکستن ماژول‌های فعلی

## 1) وضعیت فعلی پروژه

در ساختار فعلی، بخش مالی عملیاتی وجود دارد:

- فاکتور فروش (`invoices`)
- فاکتور خرید (`purchase_invoices`)
- جمع/دریافتی/مانده
- گردش موجودی مبتنی بر وضعیت نهایی فاکتور

اما هسته حسابداری دوبل (دفتر روزنامه/کل) به‌صورت رسمی هنوز کامل نبود.

## 2) چیزی که در این فاز اضافه شد

فایل migration جدید:

- `database_v1_phase2_accounting.sql`

جداول اصلی افزوده‌شده:

1. `fiscal_years` (سال مالی)
2. `chart_of_accounts` (کدینگ حساب‌ها)
3. `cost_centers` (مرکز هزینه)
4. `cash_boxes` (صندوق)
5. `bank_accounts` (حساب بانکی)
6. `journal_entries` (سند حسابداری)
7. `journal_lines` (آرتیکل‌های سند)
8. `accounting_event_rules` (قوانین صدور خودکار سند)
9. `journal_entry_links` (جلوگیری از ثبت سند تکراری)
10. `cheques` (چک/صیادی)

همراه با:

- RLS سازمان‌محور
- Triggerهای `updated_at`
- کنترل تراز بودن سند هنگام `posted`
- به‌روزرسانی خودکار جمع بدهکار/بستانکار از روی ردیف‌ها

## 3) ساختار صفحه‌ها/لیست‌های پیشنهادی حسابداری

برای اینکه محصول شبیه نرم‌افزارهای خوب ایران شود، این صفحه‌ها اولویت دارند:

1. **سال مالی**
- لیست سال‌ها
- باز/بسته کردن دوره

2. **کدینگ حساب‌ها**
- درخت حساب‌ها + لیست
- تعریف سطح حساب (کل/معین/تفصیلی)

3. **اسناد حسابداری**
- لیست اسناد
- فرم سند دستی
- ثبت نهایی/برگشت سند

4. **دفتر روزنامه**
- نمایش ردیف‌های سند بر اساس بازه تاریخ

5. **دفتر کل**
- گردش هر حساب در بازه

6. **تراز آزمایشی**
- گزارش جمع بدهکار/بستانکار قبل از بستن دوره

7. **صندوق و بانک**
- لیست صندوق‌ها
- لیست حساب‌های بانکی
- مانده و گردش

8. **چک‌ها (صیادی)**
- دریافتی/پرداختی
- وضعیت (جدید، واگذار، وصول، برگشتی...)

9. **تنظیمات مالی**
- نگاشت رویدادها به حساب‌ها (auto-posting)
- تنظیم VAT پیش‌فرض

## 4) نگاشت رویدادهای فعلی به سند حسابداری (مرحله بعد)

قانون‌های پایه پیشنهادی:

1. `sales_invoice_finalized`
- بدهکار: حساب‌های دریافتنی مشتری
- بستانکار: فروش
- بستانکار: مالیات بر ارزش افزوده

2. `purchase_invoice_finalized`
- بدهکار: خرید/موجودی
- بدهکار: اعتبار مالیات خرید
- بستانکار: حساب‌های پرداختنی تامین‌کننده

3. `sales_payment_received`
- بدهکار: صندوق/بانک
- بستانکار: دریافتنی مشتری

4. `purchase_payment_paid`
- بدهکار: پرداختنی تامین‌کننده
- بستانکار: صندوق/بانک

## 5) نکات مهم کیفیت (Critical)

1. ثبت سند باید idempotent باشد (با `journal_entry_links`).
2. سند `posted` نباید edit مستقیم بخورد؛ اصلاح با سند برگشتی/اصلاحی.
3. بستن سال مالی باید جلوی ثبت سند در بازه بسته را بگیرد.
4. محاسبه VAT باید configurable بماند (پیش‌فرض 10%).

## 6) ترتیب اجرای عملی

1. اجرای migration:
- `database_v1_phase2_accounting.sql`

2. تعریف اولیه سال مالی، کدینگ حساب، صندوق/بانک

3. تنظیم `accounting_event_rules`

4. پیاده‌سازی سرویس صدور سند خودکار از فاکتور/پرداخت

5. اضافه‌کردن UI صفحه‌های اولویت‌دار (از کدینگ و اسناد شروع شود)

## 7) Scope این فاز

این فاز فقط **DB Core** را اضافه می‌کند.

- ماژول‌های UI حسابداری در فاز بعدی اضافه می‌شوند.
- ماژول‌های فعلی فروش/خرید/انبار بدون تغییر رفتاری باقی می‌مانند.
